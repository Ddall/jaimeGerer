{% extends 'crm/crm_layout.html.twig' %}

{% block content %}

	<div class="row">
		<div class="col-md-12">
			<h1>Action commerciale</h1>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">
		    <p class="group-btn">
		    	<a href="{{ path('crm_action_commerciale_editer', {'id' : opportunite.id }) }}"  class="btn btn-warning">
		    		<span class="glyphicon glyphicon-pencil"></span> Modifier
		    	</a>  	

		    	{% if opportunite.isLost() == false and opportunite.isWon() == false %}
			    	<a href="{{ path('crm_action_commerciale_gagner', {'id' : opportunite.id }) }}" class="btn btn-success">
			    		<span class="glyphicon glyphicon-thumbs-up"></span> Marquer gagnée
			    	</a> 
			    	<a href="{{ path('crm_action_commerciale_perdre', {'id' : opportunite.id }) }}" class="btn btn-danger">
			    		<span class="glyphicon glyphicon-thumbs-down"></span> Marquer perdue
			    	</a> 
		   		{% endif %} 

		   		{% if opportunite.devis %}

		   			{% if opportunite.isLost == false %}
				    	<a href="{{ path('crm_devis_envoyer', {'id' : opportunite.devis.id }) }}"  class="btn  {% if (opportunite.devis.contact is null) %} btn-default not-active {% else %} {% if opportunite.devis.contact.email is null %} btn-default not-active {% else %} btn-primary {% endif %}{% endif %}"  data-toggle="modal" data-target="#modal">
					    	<span class="glyphicon glyphicon-send"></span> Envoyer le devis par email
					    </a>
				   {% endif %}

				    <a href="{{ path('crm_action_commerciale_exporter', {'id' : opportunite.id }) }}"  class="btn btn-primary">
		    			<span class="glyphicon glyphicon-floppy-disk"></span> Exporter le devis
		    		</a>

		    		{% if opportunite.isWon %}
	    		    	{% if facture is null or facture|length == 0 %}
	    			    	<a href="{{ path('crm_action_commerciale_convertir', {'id' : opportunite.id }) }}"  class="btn btn-primary" data-toggle="modal" data-target="#modal">
	    			    		<span class="glyphicon glyphicon-check"></span> Convertir en facture
	    			    	</a>
	    		    	{% else %}
	    			    	<a href="{{ path('crm_devis_convertir', {'id' : opportunite.devis.id }) }}"  class="btn btn-primary" data-toggle="modal" data-target="#modal">
	    			    		<span class="glyphicon glyphicon-check"></span> Ajouter une autre facture
	    			    	</a>
	    			    	{% if facture|length == 1 %}
	    						<a href="{{ path('crm_facture_voir', {'id' : facture.0.id }) }}"  class="btn btn-primary">
	    							<span class="glyphicon glyphicon-eye-open"></span> Voir la facture
	    						</a>
	    					{% elseif facture|length > 1 %}
	    						<a href="{{ path('crm_factures_devis_liste', {'id' : opportunite.devis.id }) }}"  class="btn btn-primary">
	    							<span class="glyphicon glyphicon-eye-open"></span> Voir les factures
	    						</a>
	    					{% endif %}
	    		    	{% endif %}
	    		    {% endif %}

			    	<a href="{{ path('crm_devis_impulsion', {'id' : opportunite.devis.id }) }}"  class="btn  {% if (opportunite.devis.contact is null) %} btn-default not-active {% else %} {% if opportunite.devis.contact.email is null %} btn-default not-active {% else %} btn-primary {% endif %}{% endif %}"  data-toggle="modal" data-target="#modal">
				    	<span class="glyphicon glyphicon-time"></span> Ajouter un suivi
				    </a>
				    
				{% endif %}

				<a href="{{ path('crm_action_commerciale_dupliquer', {'id' : opportunite.id }) }}"  class="btn btn-primary">
		    		<span class="glyphicon glyphicon-duplicate"></span> Dupliquer
		    	</a>

		    	<a href="{{ path('crm_action_commerciale_supprimer', {'id' : opportunite.id }) }}"  class="btn btn-danger">
		    		<span class="glyphicon glyphicon-trash"></span> Supprimer
		    	</a>

		    </p>
		    
	    </div>
    </div>

    {% if opportunite.totalBonsCommande != opportunite.montant %}
    	 <div class="row">
	    	<div class="col-md-12">
	    		<div class="alert alert-warning"><span class="glyphicon glyphicon-warning-sign"></span> Le montant total de l'action commerciale ne correspond pas au montant des bons de commande associés.</div>
	    	</div>
	    </div>
    {% endif %}

     <div class="row" id="opportunite_details">
	    	<div class="col-md-12">
	    		<h2>{{ opportunite.nom }} - {{ opportunite.montant }} &euro;<br />
    			{% if opportunite.isWon %}
    				<small class="green"><span class="glyphicon glyphicon-thumbs-up"></span> Action commerciale gagnée</small>
    			{% elseif opportunite.isLost %}
    				<small class="red"><span class="glyphicon glyphicon-thumbs-down"></span> Action commerciale perdue</small>
    			{% else %}
    				<small><span class="glyphicon glyphicon-time"></span> Action commerciale en cours</small>
    			{% endif %}
    			</h2>
	    	</div>
	    </div>
	    <div class="row">
	    	<div class="col-md-6">
	    		<table class="contact-view-table">
	    			<tbody>
						<tr>
							<td>Objet</td>
							<td>
								{{ opportunite.nom }}

							</td>
						</tr>
						<tr>
							<td>Date</td>
							<td>
								{{ opportunite.date|date("d/m/Y") }}
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="col-md-6">
	    		<table class="contact-view-table">
	    			<tbody>
	    				<tr>
							<td>Gestionnaire</td>
							<td>
								{{ opportunite.userGestion }}
								{% if opportunite.userGestion.enabled == false %}
									<a tabindex="0" role="button" data-toggle="popover" data-trigger="hover" title="Utilisateur inactif" data-content="Cet utilisateur est inactif. Vous devriez changer le gestionnaire de l'opportunité.">
										<span class="glyphicon glyphicon-warning-sign red"></span>
									</a>
								{% endif %}
							</td>
						</tr>
						<tr>
							<td>Date de validité</td>
							<td>
								{% if opportunite.devis %}
									{{ opportunite.devis.dateValidite|date("d/m/Y") }}
								{% endif %}
							</td>
						</tr>
	    			</tbody>
	    		</table>
	    	</div>
	    </div>

	    <div class="row">
			<div class="col-md-12">
				<hr />
			</div>
		</div>

	    <div class="row">
	    	<div class="col-md-6">
	    		<table class="contact-view-table">
	    			<tbody>
	    				<tr>
	    					<td>Organisation</td>
				    		<td>
				    			<a href="{{ path('crm_compte_voir', {'id' : opportunite.compte.id }) }}">
									{{ opportunite.compte.nom }}
								</a>
				    		</td>
	    				</tr>
	    				<tr>
	    					<td>Adresse</td>
	    					<td>
	    						{% if opportunite.devis %}
									{{ opportunite.devis.adresse }}
								{% endif %}
				    		</td>
	    				</tr>
	    				<tr>
	    					<td>Code postal</td>
	    					<td>
	    						{% if opportunite.devis %}
									{{ opportunite.devis.codePostal }}
								{% endif %}
				    		</td>
	    				</tr>
	    			</tbody>
	    		</table>
	    	</div>
	    	<div class="col-md-6">
	    		<table class="contact-view-table">
	    			<tbody>
	    				<tr>
							<td>Contact</td>
							<td>
								{% if opportunite.contact %}
									<a href="{{ path('crm_contact_voir', {'id' : opportunite.contact.id }) }}">
										{{ opportunite.contact.prenom }} {{ opportunite.contact.nom }}
									</a>
								{% else %}
									-
								{% endif %}
							</td>
						</tr>
						<tr>
	    					<td>Ville</td>
				    		<td>
				    			{% if opportunite.devis %}
									{{ opportunite.devis.compte.ville }}
								{% endif %}
				    		</td>
	    				</tr>
	    				<tr>
	    					<td>Région</td>
				    		<td>
				    			{% if opportunite.devis %}
									{{ opportunite.devis.compte.region }}
								{% endif %}
				    		</td>
	    				</tr>
	    				<tr>
	    					<td>Pays</td>
				    		<td>
				    			{% if opportunite.devis %}
									{{ opportunite.devis.compte.pays }}
								{% endif %}
				    		</td>
	    				</tr>
	    			</tbody>
	    		</table>
	    	</div>
	    </div>

	    <div class="row">
			<div class="col-md-12">
				<hr />
			</div>
		</div>

	    <div class="row">
			<div class="col-md-6">
				<table  class="contact-view-table">
					<tr>
    					<td>Type</td>
			    		<td>
							{{ opportunite.type }}
			    		</td>
			    		<tr>
			    			<td>Analytique</td>
			    			<td>
			    			{{ opportunite.analytique }}
			    			</td>
			    		</tr>
			    		<tr>
							<td>Probabilité</td>
							<td>{{ opportunite.probabilite.valeur }}</td>
						</tr>
    				</tr>

				</table>
			</div>
			<div class="col-md-6">
				<table  class="contact-view-table">
					<tr>
						<td>Origine</td>
						<td>
						{{ opportunite.origine }}
						</td>
					</tr>
					<tr>
						<td>Secteur</td>
						<td>
							{{ opportunite.priveOrPublicToString }}
						</td>
					</tr>
					<tr>
						<td>Appel d'offre</td>
						<td>
							{% if opportunite.appelOffre %}
								Oui
							{% else %}
								Non
							{% endif %}
						</td>
					</tr>
				</table>
			</div>
		</div>

		<div class="row">
			<div class="col-md-12">
				<hr />
			</div>
		</div>
		
		{% if opportunite.devis %}
			<div class="row">
		    	<div class="col-md-12 produit-collection produit-collection-voir">
			    	<table>
						<thead>
								<th class="produit-input-type">Type</td>
								<th class="produit-input-nom">Nom</td>
								<th class="produit-input-number">Tarif unitaire (€)</td>
								<th class="produit-input-number">Quantité</td>
								<th class="produit-input-number">Montant (€)</td>
								<th class="produit-input-number">Remise (€)</td>
								<th class="produit-input-number">Total (€)</td>
						</thead>
						<tbody>
				    	{% for produit in opportunite.devis.produits %}
							{{ include('crm/produit/crm_produit_voir.html.twig', { 'produit': produit }) }}
				    	{% endfor %}
				    	</tbody>
				    </table>
		    	</div>
		    </div>

		    <div class="row">
			    <div class="col-md-12" id="devis-calcul-wrapper">
			    	<hr />
			   		<div class="form-group">
			   			<span class="devis-label">Sous total</span>
			   			<span class="devis-montant">{{ opportunite.devis.sousTotal }} €</span>
			   		</div>
			    	<div class="form-group">
			    		<span class="devis-label">Remise</span>
			    		<span class="devis-montant">
			    			{% if opportunite.devis.remise is not null %}
			    				{{ opportunite.devis.remise }} €
			    			{% else %}
			    				-
			    			{% endif %}
			    		</span>
			    	</div>
			    	<div class="form-group">
			    		<span class="devis-label">Total HT</span>
			    		<span class="devis-montant">{{ opportunite.devis.totalHT }} €</span>
			    	</div>
					<div class="form-group">
						<span class="devis-label">TVA en %</span>
						{% if opportunite.devis.taxe is not null %}
							<span class="devis-montant">
								{{ opportunite.devis.taxePercent*100 }}%
							</span>
						{% else %}
							<span class="devis-montant">&nbsp;</span>
							<span class="devis-montant">-</span>
						{% endif %}
					</div>
					<div class="form-group">
						<span class="devis-label">TVA en €</span>
						{% if opportunite.devis.taxe is not null %}
							<span class="devis-montant">
									{{ opportunite.devis.taxe }} €
								</span>
						{% else %}
							<span class="devis-montant">&nbsp;</span>
							<span class="devis-montant">-</span>
						{% endif %}
					</div>
			   	 	<div class="form-group">
			   	 		<span class="devis-label">
			   	 			{% if opportunite.devis.taxe is not null %} Total TTC {% else %} Total prix net {% endif %}
			   	 		</span>
			   	 		<span class="devis-montant">{{ opportunite.devis.totalTTC }} €</span>
			   	 	</div>
			    </div>
			</div>

		    <div class="row">
				<div class="col-md-12">
					<hr />
				</div>
			</div>

			 <div class="row">
		    	<div class="col-md-12">
		    		<table class="contact-view-table">
		    			<tbody>
		    				<tr>
		    					<td>Description</td>
					    		<td>
									{{ opportunite.devis.description }}
					    		</td>
		    				</tr>
		    				
		    			</tbody>
		    		</table>

		    	</div>
		    </div>

	       <div class="row">
	    		<div class="col-md-12">
	    			<hr />
	    		</div>
	    	</div>

		    <div class="row">
		    	<div class="col-md-12">
		   			<table class="contact-view-table">
		    			<tbody>
		    				<tr>
		    					<td>CGV</td>
					    		<td>
									{{ opportunite.devis.cgv }}
					    		</td>
		    				</tr>
		    			</tbody>
		    		</table>
		    	</div>
		    </div>
		{% else %}
			 <div class="row">
				<div class="col-md-6">
					<table  class="contact-view-table">
						<tr>
	    					<td>Montant</td>
				    		<td>
								{{ opportunite.montant }} €
				    		</td>
				    	</tr>
				    </table>
			 	</div>
			</div>
		{% endif %}

	    <div class="row">
	 		<div class="col-md-12">
	 			<hr />
	 		</div>
	 	</div>

		{% if opportunite.isWon() %}

			<div class="row">
				<div class="col-md-12">
					<hr />
					<h3>Bons de commande 
					<a class="btn btn-primary btn-xs" href=" {{ path('crm_action_commerciale_gagner_bon_commande', {'id' : opportunite.id, 'edition' : true }) }} ">Modifer</a> 
					</h3>
					<table class="contact-view-table">
						<tbody>
						{% for bonCommande in opportunite.bonsCommande %}
							<tr>
								<td> {{ bonCommande.num }} </td>
								<td>
									{{ bonCommande.montantMonetaire|number_format(2, ',', ' ') }} €
								</td>
							</tr>
						{% endfor %}
						</tbody>
					</table>

				</div>
			</div>


			<div class="row">
				<div class="col-md-12">
					<hr />
					<h3>Répartition du montant en fonction de l'activité prévue 
						<a class="btn btn-primary btn-xs" href=" {{ path('crm_action_commerciale_gagner_repartition', {'id' : opportunite.id, 'edition' : true }) }} ">Modifer</a>
					</h3> 

					<table class="contact-view-table">
						<tbody>
						{% for repartition in opportunite.opportuniteRepartitions %}
							<tr>
								<td> {{ repartition.date|localizeddate('medium', 'none', app.request.locale, null, 'MMM YYYY' ) }} </td>
								<td>
									{{ repartition.montantMonetaire|number_format(2, ',', ' ') }} €
								</td>
								{% if opportunite.opportuniteSousTraitances|length > 0 %}
									<td>
										dont sous-traitance :
										<ul>
											{% set hasSousTraitance = false %}
											{% for sousTraitance in opportunite.opportuniteSousTraitances %}
												{% for sousTraitanceRepartition in sousTraitance.repartitions %}
													{% if sousTraitanceRepartition.date == repartition.date %}
														{% set hasSousTraitance = true %}
														<li>
															{{ sousTraitance.sousTraitant }} : {{ sousTraitanceRepartition.montantMonetaire|number_format(2, ',', ' ') }} €  
														</li>
													{% endif %}
												{% endfor %}
											{% endfor %}

											{% if hasSousTraitance == false %}
												<li>0 €</li>
											{% endif %}
										</ul>
									</td>
								{% endif %}
							</tr>
						{% endfor %}
						</tbody>
					</table>
				</div>
			</div>

			<div class="row">
				<div class="col-md-6">
					<h3>Sous-traitants <a class="btn btn-xs btn-primary" href="{{ path('crm_action_commerciale_gagner_sous_traitance', {'id' : opportunite.id }) }}">Ajouter un sous-traitant</a></h3>
					{% if opportunite.opportuniteSousTraitances|length == 0 %}
						<p>Pas de sous-traitance</p>
					{% else %}
						<table class="contact-view-table">
							<tbody>
							{% for sousTraitance in opportunite.opportuniteSousTraitances %}
								<tr>
									<td> {{ sousTraitance.sousTraitant }} </td>
									<td>
										{{ sousTraitance.montantMonetaire|number_format(2, ',', ' ') }} € <a href="{{ path('crm_action_commerciale_sous_traitance_editer', {'id' : sousTraitance.id }) }}" class="btn btn-xs btn-primary">Modifier</a>
									</td>
									<td>
										{% for depense in sousTraitance.depenses %}
											{% if loop.first %}
												Factures : 
											{% endif %}
											<a href=" {{ path('compta_depense_voir', {'id' : depense.depense.id }) }} " >{{ depense.depense.num }} </a> ({{ depense.montantMonetaire|number_format(2, ',', ' ') }} €)
											{% if loop.last == false %}
												, 
											{% endif %}
										{% endfor %}
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				{% endif %}
				</div>
				<div class="col-md-6">
					<div id="gauge-sous-traitance">
						<!-- Gauge Chart loaded by javascript -->
					</div>
				</div>
			</div>
		{% endif %}

	    <div class="row">
	    	<div class="col-md-6">
	     		<table class="contact-view-table">
	     			<tbody>
	     				<tr>
	     					<td>Créé le</td>
				    		<td>
				    			{{ opportunite.dateCreation|date("d/m/Y") }}
				    		</td>
	     				</tr>
	     				<tr>
	     					<td>Par</td>
		    				<td>
								{{ opportunite.userCreation }}
							</td>

	     				</tr>
	     			</tbody>
	     		</table>
	     	</div>
	     	<div class="col-md-6">
	     		<table class="contact-view-table">
	     			<tbody>
	     				<tr>
				    		<td>Modifié le</td>
				    		<td>
				    			{% if opportunite.dateEdition is empty %}
						    		Jamais
						    	{% else %}
									{{ opportunite.dateEdition|date("d/m/Y") }}
						    	{% endif %}
				    		</td>
			    		</tr>
			    		<tr>
		    			{% if opportunite.userEdition is not empty %}
				    		<td>Par</td>
		    				<td>
								{{ opportunite.userEdition }}
							</td>
				    	{% endif %}
			    		</tr>
	     			</tbody>
	    		</table>
	    	</div>
	    </div>

{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script src="{{ asset('lib/justgage/justgage.1.0.1.min.js') }}"></script>
	<script src="{{ asset('lib/justgage/raphael.2.1.0.min.js') }}"></script>

	<script type="text/javascript">
		$(document).ready( function () {
			{% if opportunite.isWon() %}
				var g = new JustGage({
				    id: "gauge-sous-traitance",
				    value: {{ opportunite.montantMonetaireSousTraitance|number_format(2,'.','') }},
				    min: 0,
				    max: {{ opportunite.montant }},
				    title: "Sous-traitance",
				    levelColors: ["a9d60c", "f8c700", "ff0000"],
				    levelColorsGradient: false,
				    label: "€"
					});
			{% endif %}
		});
	</script>
{% endblock %}
